How to install and run GFS2.

Refer to the cluster project page for the latest information.
http://sources.redhat.com/cluster/

Notes:
- CLVM does not yet work with the rest of the infrastructure in cvs head
  so we're using plain block devices below.


Get source
----------

Get a kernel that has GFS2 and DLM.
  See web page for git tree or download -mm?

Get the 'cluster' cvs tree, instructions at:
  http://sources.redhat.com/cluster/


Build and install
-----------------

Compile kernel with GFS2, DLM, configfs, IPV6 and SCTP.

Build and install from cluster tree.  Various parts of the tree aren't
updated yet, so just build the minimum bits shown here.

        cd cluster
        ./configure --kernel_src=/path/to/kernel

        cd cluster/ccs;                 make; make install
        cd cluster/cman;                make (*)
        cd cluster/group;               make; make install
        cd cluster/fence;               make; make install
        cd cluster/dlm/daemon;          make; make install
        cd cluster/gfs/lock_dlm/daemon; make; make install

        edit INCLUDEPATH in cluster/gfs2/mkfs/Makefile
        cd cluster/gfs2/mkfs;           make; make install
        cd cluster/gfs2/mount;          make; make install

        (*) this step downloads and builds an openais tarball from
        http://people.redhat.com/pcaulfie/


Load kernel modules
-------------------

modprobe gfs2
modprobe lock_dlm
modprobe lock_nolock
modprobe dlm
modprobe dlm_device


Configuration
-------------

Create /etc/cluster/cluster.conf
  The format and content of cluster.conf has not changed since the
  last generation of the software.  See old example here:
  http://sources.redhat.com/cluster/doc/usage.txt

Configure OpenAIS
  Add an "ais" user to /etc/passwd and an "ais" group to /etc/group.
  Create /etc/ais/groups.conf.  It's not used but needs to contain:

group {
}

  Create /etc/ais/openais.conf.  The addresses will probably need to
  be modified according to your network.

totem {
        version: 1
        secauth: off
        bindnetaddr: 10.15.84.0
        mcastaddr: 226.94.1.1
        nodeid: 20
        mcastport: 5406
        netmtu: 1500
        threads: 0
}

logging {
        logoutput: stderr
        logfile: /tmp/ais
        debug: on
        timestamp: on
}

amf {
        mode:disabled
}

components {
        openais_evs:0
        openais_clm:0
        openais_amf:0
        openais_ckpt:0
        openais_evt:0
        openais_lck:0
        openais_msg:0
        openais_cfg:0
        openais_cman:0
        openais_cpg:0
}


Startup procedure
-----------------

Run these commands on each cluster node:
debug/verbose options in [] can be useful at this stage :)

> mount -t configfs none /config
> ccsd -X
> cd cluster/cman/cman_tool; ./cman_tool join [-d]
> groupd [-D]
> fenced [-D]
> fence_tool join
> dlm_controld [-D]
> lock_dlm [-D]
> mkfs -p lock_dlm -t <clustername>:<fsname> -j <#journals> <blockdev>
> mount -t gfs2 [-v] <blockdev> <mountpoint>

> group_tool ls
        Shows registered groups, similar to what cman_tool services did.


Shutdown procedure
------------------

Doesn't work yet

Run these commands on each cluster node:

> umount <mountpoint>
> fence_tool leave
> cman_tool leave

