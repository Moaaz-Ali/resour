How to install and run GFS2.

Refer to the cluster project page for the latest information.
http://sources.redhat.com/cluster/

Notes:
- CLVM needs to be patched to use libcman. Checkout LVM2 as normal
  and apply the patch from cluster/cman/lib/clvmd-libcman.diff


Get source
----------

Get a kernel that has GFS2 and DLM.
  See web page for git tree or download -mm?

Get the 'cluster' cvs tree, instructions at:
  http://sources.redhat.com/cluster/

Optionally, get the LVM2 cvs from
  cvs -d :pserver:cvs@sources.redhat.com:/cvs/lvm2
  and apply the patch mentioned above:
   cd LVM2
   patch -p0 < ../cluster/cman/lib/clvmd-libcman.diff

   

Build and install
-----------------

Compile kernel with GFS2, DLM, configfs, IPV6 and SCTP.

Build and install from cluster tree.  Various parts of the tree aren't
updated yet, so just build the minimum bits shown here.

        cd cluster
        ./configure --kernel_src=/path/to/kernel

        cd cluster/ccs;                 make; make install
        cd cluster/cman;                make (*)
        cd cluster/group;               make; make install
        cd cluster/fence;               make; make install
        cd cluster/dlm;                 make; make install
        cd cluster/gfs/lock_dlm/daemon; make; make install

        edit INCLUDEPATH in cluster/gfs2/mkfs/Makefile
        cd cluster/gfs2/mkfs;           make; make install
        cd cluster/gfs2/mount;          make; make install

        (*) this step downloads and builds an openais tarball from
        http://people.redhat.com/pcaulfie/

	See old instructions for configuring & building LVM2 & CLVM.


Load kernel modules
-------------------

modprobe gfs2
modprobe lock_dlm
modprobe lock_nolock
modprobe dlm
modprobe dlm_device


Configuration
-------------

Create /etc/cluster/cluster.conf
  The format and content of cluster.conf has changed little since the
  last generation of the software.  See old example here:
  http://sources.redhat.com/cluster/doc/usage.txt
  The one change you will need to make is to add nodeids for all nodes
  in the cluster. These are now mandatory. eg:

     <clusternode name="node12.mycluster.mycompany.com" votes="1" nodeid="12">

Startup procedure
-----------------

Run these commands on each cluster node:
debug/verbose options in [] can be useful at this stage :)

> mount -t configfs none /config
> ccsd -X
> cman_tool join [-d]
> groupd [-D]
> fenced [-D]
> fence_tool join
> dlm_controld [-D]
> gfs_controld [-D]
> mkfs -t gfs2 -p lock_dlm -t <clustername>:<fsname> -j <#journals> <blockdev>
> mount -t gfs2 [-v] <blockdev> <mountpoint>

> group_tool ls
        Shows registered groups, similar to what cman_tool services did.


Shutdown procedure
------------------

Notes:
You need util-linux 2.13-pre6 version of umount(8), older versions do not
call the umount.gfs2 helper.

Run these commands on each cluster node:

> umount -t gfs2 [-v] <mountpoint>
> fence_tool leave
> cman_tool leave

